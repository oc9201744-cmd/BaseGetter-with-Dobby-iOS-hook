name: XO-VIP-FINAL-FIXED

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Dylib
        run: |
          set -e

          echo "üìÅ .xcodeproj buluyoruz..."
          PROJECT_FILE=$(find . -maxdepth 3 -type d -name "*.xcodeproj" | head -n 1)
          if [ -z "$PROJECT_FILE" ]; then
            echo "HATA: .xcodeproj bulunamadƒ±!"
            exit 1
          fi
          echo "Proje: $PROJECT_FILE"

          echo "üéØ Target ismini alƒ±yoruz..."
          TARGET_NAME=$(xcodebuild -list -project "$PROJECT_FILE" | awk '/Targets:/{flag=1;next} /^$/{flag=0} flag {print $1; exit}')
          if [ -z "$TARGET_NAME" ]; then
            echo "HATA: Target bulunamadƒ±!"
            exit 1
          fi
          echo "Target: $TARGET_NAME"

          echo "üõ†  Derleme ba≈ülƒ±yor..."
          xcodebuild \
            -project "$PROJECT_FILE" \
            -target "$TARGET_NAME" \
            -configuration Release \
            -sdk iphoneos \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=NO \
            clean build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            CLANG_ENABLE_MODULES=YES \
            OTHER_CFLAGS="-fobjc-arc -I$(pwd)/include -O3" \
            OTHER_LDFLAGS="-L$(pwd)/lib -ldobby -lc++ -lobjc -framework UIKit -framework Foundation -framework CoreFoundation -framework Metal -framework QuartzCore -framework Security"

          echo "‚úÖ Build bitti. √úretilen dylib'leri arƒ±yoruz..."
          find build -type f -name '*.dylib' -print || echo "Hi√ß .dylib bulunamadƒ±"

      - name: Upload Dylib Artifact
        uses: actions/upload-artifact@v4
        with:
          name: XO-VIP-Dylib
          # build altƒ±ndaki T√úM .dylib‚Äôleri topla
          path: |
            build/**/*.dylib